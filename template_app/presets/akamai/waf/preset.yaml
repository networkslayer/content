name: akamai_waf
author: Antimatter
description: "A preset for consuming logs generated by Akamai WAF logs"
title: "Akamai - WAF"
iconURL: "https://raw.githubusercontent.com/antimatterhq/dasl-content-packs/refs/heads/main/presets/akamai/waf/icon.png"

autoloader:
  format: json
  cloudFiles:
    options:
      

bronze:
  loadAsSingleVariant: true
  preTransform:
  - ["data", "to_timestamp(from_unixtime(CAST(data:httpMessage.start AS BIGINT))) as time", "CAST('akamai' AS STRING) AS source", "CAST('waf' AS STRING) AS sourcetype"]

silver:
  transform:
    - name: akamai_waf_http_activity
      fields:
        - name: time
          from: time

        - name: raw_data
          from: data

        - name: attackData
          expr: |
            TRY_CAST(
              data:attackData AS STRUCT<
                clientIP: STRING,
                clientReputation: STRING,
                configId: STRING,
                policyId: STRING,
                ruleActions: STRING,
                ruleData: STRING,
                ruleMessages: STRING,
                ruleSelectors: STRING,
                ruleTags: STRING,
                ruleVersions: STRING,
                rules: STRING
              >
            )

        - name: format
          expr: |
            CAST(data:format AS STRING)

        - name: geo
          expr: |
            TRY_CAST(
              data:geo AS STRUCT<
                asn: STRING,
                city: STRING,
                continent: STRING,
                country: STRING,
                regionCode: STRING
              >
            )

        - name: httpMessage
          expr: |
            TRY_CAST(
              data:httpMessage AS STRUCT<
                bytes: STRING,
                host: STRING,
                method: STRING,
                path: STRING,
                port: STRING,
                protocol: STRING,
                query: STRING,
                requestHeaders: MAP<STRING, STRING>,
                requestId: STRING,
                responseHeaders: MAP<STRING, STRING>,
                start: STRING,
                status: STRING,
                tls: STRING
              >
            )

        - name: serviceID
          expr: |
            CAST(data:serviceID AS STRING)

        - name: type
          expr: |
            CAST(data:type AS STRING)

        - name: version
          expr: |
            CAST(data:version AS STRING)

      utils:
        unreferencedColumns:
          preserve: true

gold:
  - name: http_activity
    input: akamai_waf_http_activity
    fields:

      # ------------------ core timestamps ------------------
      - name: time
        from: time

      - name: timezone_offset
        expr: CAST(0 AS INT)

      # ------------------ raw_data as variant --------------
      - name: raw_data
        expr: cast(parse_json(to_json(raw_data)) as VARIANT)

      # ------------------ core base fields -----------------
      - name: activity_id
        expr: |
          CASE
            WHEN LOWER(httpMessage.method) = 'connect' THEN 1
            WHEN LOWER(httpMessage.method) = 'delete' THEN 2
            WHEN LOWER(httpMessage.method) = 'get' THEN 3
            WHEN LOWER(httpMessage.method) = 'head' THEN 4
            WHEN LOWER(httpMessage.method) = 'options' THEN 5
            WHEN LOWER(httpMessage.method) = 'post' THEN 6
            WHEN LOWER(httpMessage.method) = 'put' THEN 7
            WHEN LOWER(httpMessage.method) = 'trace' THEN 8
            WHEN httpMessage.method IS NULL OR httpMessage.method = '' THEN 0
            ELSE 99
          END

      - name: activity
        expr: |
          CASE
            WHEN LOWER(httpMessage.method) = 'connect' THEN 'Connect'
            WHEN LOWER(httpMessage.method) = 'delete' THEN 'Delete'
            WHEN LOWER(httpMessage.method) = 'get' THEN 'Get'
            WHEN LOWER(httpMessage.method) = 'head' THEN 'Head'
            WHEN LOWER(httpMessage.method) = 'options' THEN 'Options'
            WHEN LOWER(httpMessage.method) = 'post' THEN 'Post'
            WHEN LOWER(httpMessage.method) = 'put' THEN 'Put'
            WHEN LOWER(httpMessage.method) = 'trace' THEN 'Trace'
            WHEN httpMessage.method IS NULL OR httpMessage.method = '' THEN 'Unknown'
            ELSE 'Unknown'
          END

      - name: activity_name
        expr: |
          CASE
            WHEN LOWER(httpMessage.method) = 'connect' THEN 'Connect'
            WHEN LOWER(httpMessage.method) = 'delete' THEN 'Delete'
            WHEN LOWER(httpMessage.method) = 'get' THEN 'Get'
            WHEN LOWER(httpMessage.method) = 'head' THEN 'Head'
            WHEN LOWER(httpMessage.method) = 'options' THEN 'Options'
            WHEN LOWER(httpMessage.method) = 'post' THEN 'Post'
            WHEN LOWER(httpMessage.method) = 'put' THEN 'Put'
            WHEN LOWER(httpMessage.method) = 'trace' THEN 'Trace'
            WHEN httpMessage.method IS NULL OR httpMessage.method = '' THEN 'Unknown'
            ELSE 'Unknown'
          END

      - name: app_name
        literal: "Akamai"

      - name: category_uid
        expr: CAST(4 AS INT)

      - name: category_name
        literal: "Network Activity"

      - name: class_uid
        expr: CAST(4002 AS INT)

      - name: class_name
        literal: "HTTP Activity"

      - name: severity_id
        expr: CAST(1 AS INT)

      - name: severity
        literal: "Informational"

      - name: type_uid
        expr: |
          CAST(
            400200 +
            CASE
              WHEN LOWER(httpMessage.method) = 'connect' THEN 1
              WHEN LOWER(httpMessage.method) = 'delete' THEN 2
              WHEN LOWER(httpMessage.method) = 'get' THEN 3
              WHEN LOWER(httpMessage.method) = 'head' THEN 4
              WHEN LOWER(httpMessage.method) = 'options' THEN 5
              WHEN LOWER(httpMessage.method) = 'post' THEN 6
              WHEN LOWER(httpMessage.method) = 'put' THEN 7
              WHEN LOWER(httpMessage.method) = 'trace' THEN 8
              WHEN httpMessage.method IS NULL OR httpMessage.method = '' THEN 0
              ELSE 99
            END
          AS BIGINT)

      - name: type_name
        expr: |
          CASE
            WHEN httpMessage.method IS NOT NULL
            THEN CONCAT('HTTP Activity: ', httpMessage.method)
            ELSE NULL
          END

      - name: status_id
        expr: |
          CASE
            WHEN CAST(httpMessage.status AS INT) BETWEEN 200 AND 299 THEN 1
            WHEN CAST(httpMessage.status AS INT) >= 300 THEN 2
            ELSE 0
          END

      - name: status
        expr: |
          CASE
            WHEN CAST(httpMessage.status AS INT) BETWEEN 200 AND 299 THEN 'Success'
            WHEN CAST(httpMessage.status AS INT) >= 300 THEN 'Failure'
            ELSE 'Unknown'
          END

      - name: status_detail
        expr: CAST(httpMessage.responseHeaders['Connection'] AS STRING)

      - name: status_code
        expr: CAST(httpMessage.status AS STRING)

      # ------------------ connection_info (STRUCT) ------------------
      - name: connection_info.direction
        literal: "Inbound"

      - name: connection_info.direction_id
        expr: CAST(NULL AS INT)

      - name: connection_info.flag_history
        expr: CAST(NULL AS STRING)

      - name: connection_info.protocol_name
        expr: httpMessage.protocol

      - name: connection_info.protocol_num
        expr: CAST(NULL AS INT)

      - name: connection_info.protocol_ver
        expr: CAST(NULL AS STRING)

      - name: connection_info.protocol_ver_id
        expr: CAST(NULL AS INT)

      - name: connection_info.uid
        expr: CAST(NULL AS STRING)

      # ------------------ dst_endpoint (STRUCT) ------------------
      - name: dst_endpoint.domain
        expr: httpMessage.host

      - name: dst_endpoint.hostname
        expr: httpMessage.host

      - name: dst_endpoint.instance_uid
        expr: CAST(NULL AS STRING)

      - name: dst_endpoint.interface_name
        expr: CAST(NULL AS STRING)

      - name: dst_endpoint.interface_uid
        expr: CAST(NULL AS STRING)

      - name: dst_endpoint.ip
        expr: CAST(NULL AS STRING)

      - name: dst_endpoint.name
        expr: CAST(NULL AS STRING)

      - name: dst_endpoint.port
        expr: CAST(httpMessage.port AS INT)

      - name: dst_endpoint.svc_name
        expr: CAST(NULL AS STRING)

      - name: dst_endpoint.type
        literal: "Server"

      - name: dst_endpoint.type_id
        expr: CAST(1 AS INT)

      - name: dst_endpoint.uid
        expr: CAST(NULL AS STRING)

      - name: dst_endpoint.location
        expr: |
          named_struct(
            'city',         CAST(NULL AS STRING),
            'continent',    CAST(NULL AS STRING),
            'country',      CAST(NULL AS STRING),
            'lat',          CAST(NULL AS FLOAT),
            'long',         CAST(NULL AS FLOAT),
            'postal_code',  CAST(NULL AS STRING)
          )

      - name: dst_endpoint.mac
        expr: CAST(NULL AS STRING)

      - name: dst_endpoint.vpc_uid
        expr: CAST(NULL AS STRING)

      - name: dst_endpoint.zone
        expr: CAST(NULL AS STRING)

      # ------------------ http_request (STRUCT) ------------------
      - name: http_request.args
        expr: CAST(NULL AS STRING)

      - name: http_request.body_length
        expr: CAST(NULL AS INT)

      - name: http_request.http_headers
        expr: |
          transform(
            map_entries(httpMessage.requestHeaders),
            x -> named_struct('name', x.key, 'value', x.value)
          )

      - name: http_request.http_method
        from: httpMessage.method

      - name: http_request.length
        expr: CAST(httpMessage.bytes AS INT)

      - name: http_request.referrer
        expr: CAST(NULL AS STRING)

      - name: http_request.url
        expr: cast(NULL AS STRING)

      - name: http_request.user_agent
        expr: httpMessage.requestHeaders['User-Agent']

      - name: http_request.version
        from: httpMessage.protocol

      # ------------------ http_response (STRUCT) ------------------
      - name: http_response.body_length
        expr: CAST(httpMessage.responseHeaders['Content-Length'] AS INT)

      - name: http_response.code
        expr: CAST(httpMessage.status AS INT)

      - name: http_response.content_type
        expr: httpMessage.responseHeaders['Content-Type']

      - name: http_response.http_headers
        expr: |
          transform(
            map_entries(httpMessage.responseHeaders),
            x -> named_struct('name', x.key, 'value', x.value)
          )

      - name: http_response.latency
        expr: CAST(NULL AS INT)

      - name: http_response.length
        expr: CAST(NULL AS INT)

      - name: http_response.message
        expr: CAST(NULL AS STRING)

      - name: http_response.status
        expr: CAST(NULL AS STRING)

      # ------------------ src_endpoint (STRUCT) ------------------
      - name: src_endpoint.domain
        expr: CAST(NULL AS STRING)

      - name: src_endpoint.hostname
        expr: CAST(NULL AS STRING)

      - name: src_endpoint.instance_uid
        expr: CAST(NULL AS STRING)

      - name: src_endpoint.interface_name
        expr: CAST(NULL AS STRING)

      - name: src_endpoint.interface_uid
        expr: CAST(NULL AS STRING)

      - name: src_endpoint.ip
        from: attackData.clientIP

      - name: src_endpoint.name
        expr: CAST(NULL AS STRING)

      - name: src_endpoint.port
        expr: CAST(NULL AS INT)

      - name: src_endpoint.svc_name
        expr: CAST(NULL AS STRING)

      - name: src_endpoint.type
        expr: CAST(NULL AS STRING)

      - name: src_endpoint.type_id
        expr: CAST(NULL AS INT)

      - name: src_endpoint.uid
        expr: CAST(NULL AS STRING)

      - name: src_endpoint.location
        expr: |
          named_struct(
            'city',         CAST(NULL AS STRING),
            'continent',    CAST(NULL AS STRING),
            'country',      CAST(NULL AS STRING),
            'lat',          CAST(NULL AS FLOAT),
            'long',         CAST(NULL AS FLOAT),
            'postal_code',  CAST(NULL AS STRING)
          )

      - name: src_endpoint.mac
        expr: CAST(NULL AS STRING)

      - name: src_endpoint.vpc_uid
        expr: CAST(NULL AS STRING)

      - name: src_endpoint.zone
        expr: CAST(NULL AS STRING)

      # ------------------ policy (STRUCT) ------------------
      - name: policy.is_applied
        expr: CAST(NULL AS BOOLEAN)
      - name: policy.name
        expr: CAST(NULL AS STRING)
      - name: policy.uid
        expr: attackData.policyId
      - name: policy.version
        expr: CAST(NULL AS STRING)

      # ------------------ metadata (STRUCT) ------------------
      - name: metadata.correlation_uid
        expr: CAST(NULL AS STRING)

      - name: metadata.event_code
        expr: CAST(NULL AS STRING)

      - name: metadata.log_level
        expr: CAST(NULL AS STRING)

      - name: metadata.log_name
        literal: "waf"

      - name: metadata.log_provider
        literal: "akamai"

      - name: metadata.log_version
        expr: CAST(NULL AS STRING)

      - name: metadata.logged_time
        from: time

      - name: metadata.modified_time
        expr: CAST(NULL AS TIMESTAMP)

      - name: metadata.original_time
        expr: cast(time as STRING)

      - name: metadata.processed_time
        expr: current_timestamp()

      - name: metadata.product.name
        literal: "Kona"

      - name: metadata.product.vendor_name
        literal: "Akamai"

      - name: metadata.product.version
        from: version

      - name: metadata.tags
        expr: CAST(NULL AS VARIANT)

      - name: metadata.tenant_uid
        expr: CAST(NULL AS STRING)

      - name: metadata.uid
        expr: attackData.configId

      - name: metadata.version
        expr: CAST(NULL AS STRING)

      # ------------------ action / disposition / text fields ------------------
      - name: message
        literal: "Inbound Request"

      - name: action
        expr: |
          CASE
            WHEN attackData.ruleActions = 'deny' THEN 'Denied'
            WHEN attackData.ruleActions IN ('alert','monitor') THEN 'Observed'
            WHEN attackData.ruleActions = 'tarpit' THEN 'Modified'
            WHEN attackData.ruleActions = 'allow' THEN 'Allowed'
            ELSE 'Unknown'
          END

      - name: action_id
        expr: |
          CASE
            WHEN attackData.ruleActions = 'deny' THEN 2
            WHEN attackData.ruleActions IN ('alert','monitor') THEN 3
            WHEN attackData.ruleActions = 'tarpit' THEN 4
            WHEN attackData.ruleActions = 'allow' THEN 1
            ELSE 0
          END

      - name: disposition
        expr: |
          CASE
            WHEN attackData.ruleActions = 'deny' THEN 'Blocked'
            WHEN attackData.ruleActions = 'alert' THEN 'Alert'
            WHEN attackData.ruleActions = 'monitor' THEN 'Logged'
            WHEN attackData.ruleActions = 'tarpit' THEN 'Delayed'
            WHEN attackData.ruleActions = 'allow' THEN 'Allowed'
            ELSE 'Unknown'
          END

      - name: disposition_id
        expr: |
          CASE
            WHEN attackData.ruleActions = 'deny' THEN 2
            WHEN attackData.ruleActions = 'alert' THEN 19
            WHEN attackData.ruleActions = 'monitor' THEN 17
            WHEN attackData.ruleActions = 'tarpit' THEN 14
            WHEN attackData.ruleActions = 'allow' THEN 1
            ELSE 0
          END

      # ------------------ enrichments (ARRAY<STRUCT>) ------------------
      - name: enrichments
        expr: |
          CASE
            WHEN attackData.clientReputation IS NOT NULL THEN array(named_struct(
              'data',  CAST(attackData.clientReputation AS VARIANT),
              'desc',  CAST(NULL AS STRING),
              'name',  'clientReputation',
              'value', CAST(attackData.clientReputation AS STRING)
            ))
            ELSE CAST(array() AS ARRAY<STRUCT<
              data: VARIANT,
              desc: STRING,
              name: STRING,
              value: STRING
            >>)
          END

      # ------------------ arrays / structs with block quotes ------------------
      - name: file
        expr: |
          named_struct('name', CAST(NULL AS STRING), 'path', CAST(NULL AS STRING))

      - name: http_cookies
        expr: |
          CAST(array() AS ARRAY<STRUCT<
            domain: STRING,
            expiration_time: TIMESTAMP,
            http_only: BOOLEAN,
            is_http_only: BOOLEAN,
            is_secure: BOOLEAN,
            name: STRING,
            path: STRING,
            samesite: STRING,
            secure: BOOLEAN,
            value: STRING
          >>)

      - name: observables
        expr: |
          CAST(array() AS ARRAY<STRUCT<name: STRING, type: STRING, value: STRING>>)

      # ------------------ firewall_rule (STRUCT) ------------------
      - name: firewall_rule.name
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.uid
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.category
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.desc
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.type
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.version
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.condition
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.duration
        expr: CAST(NULL AS BIGINT)
      - name: firewall_rule.match_details
        expr: |
          CAST(array() AS ARRAY<STRING>)
      - name: firewall_rule.match_location
        expr: CAST(NULL AS STRING)
      - name: firewall_rule.rate_limit
        expr: CAST(NULL AS INT)
      - name: firewall_rule.sensitivity
        expr: CAST(NULL AS STRING)

      # ------------------ traffic (STRUCT) ------------------
      - name: traffic.bytes
        expr: CAST(NULL AS BIGINT)
      - name: traffic.bytes_in
        expr: CAST(NULL AS BIGINT)
      - name: traffic.bytes_missed
        expr: CAST(NULL AS BIGINT)
      - name: traffic.bytes_out
        expr: CAST(NULL AS BIGINT)
      - name: traffic.chunks
        expr: CAST(NULL AS BIGINT)
      - name: traffic.chunks_in
        expr: CAST(NULL AS BIGINT)
      - name: traffic.chunks_out
        expr: CAST(NULL AS BIGINT)
      - name: traffic.packets
        expr: CAST(NULL AS BIGINT)
      - name: traffic.packets_in
        expr: CAST(NULL AS BIGINT)
      - name: traffic.packets_out
        expr: CAST(NULL AS BIGINT)

      # ------------------ unmapped ------------------
      - name: unmapped
        expr: CAST(NULL AS VARIANT)
